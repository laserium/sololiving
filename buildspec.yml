version: 0.2

env:
  variables:
    SPRING_PROFILES_ACTIVE: test

phases:
  install:
    runtime-versions:
      java: corretto17
    commands:
      - echo "Installing dependencies..."
      - chmod +x ./gradlew
      - ./gradlew dependencies
  pre_build:
    commands:
      - echo "Cleaning up old files..."
      - rm -rf /path/to/old/deployments/*
      - echo "Restoring cache..."
      - cp -R /root/.gradle/cache /codebuild/output/.cache/ || true
  build:
    commands:
      - echo "Building the project..."
      - ./gradlew build -x test
  post_build:
    commands:
      - echo "Build completed on `date`"
      - echo "Running tests..."
      - ./gradlew test
      - echo "Saving cache..."
      - cp -R /codebuild/output/.cache /root/.gradle/cache
      - echo "Deploying the project..."
      - cp -R /path/to/new/deployment/files/* /path/to/deployment/

artifacts:
  files:
    - build/libs/*.jar
    - appspec.yml
    - scripts/**

cache:
  paths:
    - /root/.gradle/cache

reports:
  junit:
    files:
      - build/reports/tests/test/*.xml
