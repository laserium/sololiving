<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.sololiving.domain.article.mapper.ArticleMapper">

    <!-- 게시글 작성 -->
    <insert id="insertArticle" parameterType="com.sololiving.domain.article.vo.ArticleVo" useGeneratedKeys="true" keyProperty="articleId">
        INSERT INTO ARTICLE (writer, title, content, category_code)
        VALUES (#{writer}, #{title}, #{content}, #{categoryCode})
    </insert>

    <!-- 모든 게시글의 score 컬럼을 업데이트하는 SQL -->
    <update id="updateAllArticleScores">
        UPDATE ARTICLE a
        SET a.score = (
            a.like_cnt * 10 + 
            (SELECT COUNT(*) FROM COMMENT c WHERE c.article_id = a.article_id) * 2
        )
    </update>

    <!-- 조회수 업데이트  -->
    <update id="updateViewCount">
        UPDATE ARTICLE
        SET view_cnt = view_cnt + #{viewCount}
        WHERE article_id = #{articleId}
    </update>

    <!-- 게시글 수정 : 작성자 검증 -->
    <select id="verifyArticleWriter" resultType="boolean">
        SELECT EXISTS (
            SELECT 1
            FROM ARTICLE
            WHERE article_id = #{articleId}
            AND writer = #{userId}
        )
    </select>

    <!-- 게시글 수정 : UPDATE -->
    <update id="updateArticle">
        UPDATE ARTICLE
        SET title = #{title},
            content = #{content},
            category_code = #{categoryCode}
        WHERE article_id = #{articleId}
    </update>

    <!-- 게시글 전체 SELECT -->
    <select id="selectByArticleId" resultType="com.sololiving.domain.article.vo.ArticleVo">
        SELECT *
        FROM article
        WHERE article_id = #{articleId}
    </select>

    <!-- 게시글 삭제 : 게시글 상태를 삭제로 변경 UPDATE -->
    <update id="updateArticleAsDeleted">
        UPDATE ARTICLE
        SET title = '삭제된 게시글',
            content = '삭제된 게시글',
            like_cnt = 0,
            view_cnt = 0,
            score = 0,
            status = 'DELETED',
            updated_at = CURRENT_TIMESTAMP
        WHERE article_id = #{articleId}
    </update>

</mapper>
